<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu TTech</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #121212; /* Un negro mate muy pro */
            color: #e0e0e0;
            margin: 0; 
            padding: 40px; 
        }
        
        h1 { text-align: center; color: #ffffff; margin-bottom: 40px; }

        /* CONTENEDOR GRID */
        #lista-productos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            padding: 10px;
        }

        @media (max-width: 600px) {
            #lista-productos {
                grid-template-columns: repeat(2, 1fr); /* 2 productos por fila exactos */
                gap: 8px;
                padding: 5px;
            }

            .card {
                padding: 8px;
            }

            .card img {
                height: 100px; /* Imagen un poco más chica en celu */
            }

            .card h3 {
                font-size: 0.9rem; /* Título más acorde al tamaño */
                margin: 5px 0;
            }
        }

        /* TARJETA DE PRODUCTO */
        .card { 
            background: #1e1e1e; 
            border-radius: 15px;
            border: 1px solid #333; 
            overflow: hidden; 
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            border: 1px solid #eee;
        }

        .card:hover { 
            transform: translateY(-10px); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.1); 
        }

        /* IMAGEN DEL PRODUCTO */
        .img-container {
            width: 100%;
            height: 200px;
            background: #000000; /* Fondo negro absoluto */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px; /* Espacio para que el borde no toque los bordes de la card */
            box-sizing: border-box;
        }

        .card img { 
            max-width: 95%; 
            max-height: 95%; 
            object-fit: contain; 
            border: 2px solid #ffffff; /* El borde blanco que querías */
            border-radius: 8px;        /* Bordes redondeados para el marco */
            padding: 5px;              /* Espacio entre la foto y el borde blanco */
            background: #000000;       /* Fondo negro tras la imagen por si es transparente */
        }

        #tooltip-descripcion {
            transition: opacity 0.2s ease-in-out;
            pointer-events: none; /* Evita que el mouse 'choque' con el cartelito */
        }

        .producto-titulo {
            cursor: help;
            color: #03dac6; /* O el color que prefieras para destacar que hay algo ahí */
        }

        /* TEXTOS */
        .info { 
            display: flex;
            flex-direction: column; 
            align-items: center;    
            text-align: center;
            padding: 10px;
            background: url('http://192.168.1.41:8081/uploads/textura.jpg') center/cover no-repeat;
            color: white; 
        }
        .card h3 { margin: 0 0 10px; font-size: 1.2rem; color: #ffffff; }
        .category { 
            color:  #bb86fc; 
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        #categorias-nav {
            display: flex;
            flex-wrap: wrap;       /* Permite que bajen si no entran */
            overflow-x: auto; /* Permite scroll horizontal */
            white-space: nowrap;
            justify-content: center; /* ESTO CENTRA LOS BOTONES */
            padding: 10px;
            gap: 10px;
            margin-bottom: 10px;
        }

        #categorias-nav::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            background: #1e1e1e;
            border: 2px solid #bb86fc;
            color: #bb86fc;
            flex: 0 0 auto; /* Evita que los botones se achiquen */
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;

        }

        .price { 
            color: #03dac6;
            font-size: 1.2rem; 
            font-weight: bold; 
            display: block;
            margin-top: 10px;
        }

        .filter-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #bb86fc;
            color: #121212;
        }

        /* Clase para ocultar productos que no coincidan */
        .card.hidden {
            display: none;
        }

        .price-hidden {
            color: #bb86fc; /* El color lila que venimos usando */
            font-style: italic;
            font-size: 1rem;
            margin: 10px 0;
            font-weight: bold;
        }

        .btn-login-invite {
            background: transparent;
            border: 1px solid #bb86fc;
            color: #bb86fc;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            width: 100%;
            transition: 0.3s;
        }

        .btn-login-invite:hover {
            background: #bb86fc;
            color: #121212;
        }

    </style>
</head>
<body>
    <div id="menu-usuario" style="position: absolute; top: 10px; right: 10px; z-index: 1000; text-align: right;">
        <div th:if="${session.usuarioNombre != null}">
            <span style="color: #03dac6; font-weight: bold;">
                Hola, <span th:text="${session.usuarioNombre}"></span>!
            </span>
            <br>
            <a href="/perfil.html" style="color: #bb86fc; text-decoration: none; font-size: 0.9rem;">⚙️ Editar Perfil</a>
            <br>
            <a href="/logout" style="color: #ff5252; text-decoration: none; font-size: 0.8rem;">Cerrar Sesión</a>
        </div>
    </div>
    <div class="header-container">
        <h1 class="logo-title">EL TURCO</h1>
    </div>
    <div class="search-container" style="text-align: center; margin-bottom: 20px;">
        <input type="text" id="busqueda" placeholder="Buscar producto..." 
            onkeyup="filtrarPorTexto()" 
            style="padding: 10px; width: 80%; max-width: 400px; border-radius: 20px; border: 1px solid #ccc; background: #1e1e1e; color: white;">
    </div>
    <div class="filter-container">
        <div id="categorias-nav"></div>
        <div id="subcategorias-nav" style="margin-top: 15px;"></div>
    </div>

    <div id="lista-productos">Cargando menú...</div>

    <div id="tooltip-descripcion" style="
        display: none; 
        position: absolute; 
        background: #333; 
        color: white; 
        padding: 10px; 
        border-radius: 5px; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        z-index: 2000;
        max-width: 250px;
        font-size: 0.9em;
    "></div>

    <script th:inline="javascript">

    const API_URL = 'http://192.168.1.41:8081';
    const rolSesion = /*[[${session.rol}]]*/ null;
    const nombreUsuario = /*[[${session.usuarioNombre}]]*/ 'Invitado';
    // El usuario está "logueado" si es ADMIN o CLIENTE
    let usuarioLogueado = (rolSesion === 'ADMIN' || rolSesion === 'CLIENTE'); 
    console.log("Rol detectado:", rolSesion);
    console.log("Sesión recuperada - Rol:", rolSesion, "Nombre:", nombreUsuario);
    let categoriasData = [];

    const tooltip = document.getElementById('tooltip-descripcion');

    fetch(`${API_URL}/categories/list`)
        .then(res => res.json())
        .then(data => {
            categoriasData = data;
            const navPrincipal = document.getElementById('categorias-nav');
            navPrincipal.innerHTML = '<button class="filter-btn active" onclick="seleccionarPrincipal(null, this)">Todos</button>';
            
            const principales = data.filter(c => c.parent === null);
            principales.forEach(cat => {
                // Pasamos el ID de la categoría principal
                navPrincipal.innerHTML += `<button class="filter-btn" onclick="seleccionarPrincipal(${cat.id}, this)">${cat.name}</button>`;
            });
        })

    document.addEventListener("DOMContentLoaded", function() {
        cargarProductos();
    });

    function cargarProductos(datos = null) {
        
        // Si ya tenemos los datos (porque filtramos), los procesamos directo
        if (datos) {
            renderizarCards(datos);
            return;
        }

        // Si no hay datos, vamos a buscarlos todos (carga inicial)
        fetch(`${API_URL}/products/list`)
            .then(response => response.json())
            .then(data => {
                renderizarCards(data);
            })
            .catch(err => {
                document.getElementById('lista-productos').innerHTML = "Error al conectar con el servidor.";
                console.error("Error:", err);
            });
    }

    function renderizarCards(data) {
        const div = document.getElementById('lista-productos');
        
        div.innerHTML = data.map(p => {
            let precioContenido = "";
            let botonAccion = "";

            if (usuarioLogueado) {
                // Nota: El innerHTML del menu-usuario hacelo AFUERA de este map 
                // para que no se repita por cada producto, pero lo dejo por ahora.
                precioContenido = `<span class="price">$ ${p.price.toLocaleString('es-AR')}</span>`;
                botonAccion = `<button class="btn-login-invite" onclick="enviarWhatsApp('${p.title}')" style="background: #25d366; color: white; border-color: #25d366;">Pedir por WhatsApp</button>`;
            } else {
                precioContenido = `
                    <p style="margin:5px 0;">
                        <a href="https://wa.me/5491139318082?text=Hola, precio de: ${p.title}" target="_blank" style="color: #03dac6; text-decoration: none; font-weight: bold;">
                            Precio: Consultar
                        </a>
                    </p>`;
                botonAccion = `<button class="btn-login-invite" onclick="abrirModalLogin()">Ingresar para ver precio</button>`;
            }

            return `
            <div class="card"
                data-id="${p.id}" 
                data-category-id="${p.category ? p.category.id : ''}" 
                data-category-name="${p.category ? p.category.name : 'General'}">
                <div class="img-container">
                    <img src="${p.imageURL ? API_URL + '/uploads/' + p.imageURL : 'https://via.placeholder.com/200'}" alt="${p.title}">
                </div>
                <div class="info">
                    <span class="category">${p.category ? p.category.name : 'General'}</span>
                    
                    <h3 class="producto-titulo" 
                        onmouseover="mostrarDescripcion(event, '${p.description ? p.description.replace(/'/g, "\\'") : 'Sin descripción'}')" 
                        onmouseout="ocultarDescripcion()">
                        ${p.title}
                    </h3>
                    
                    ${precioContenido}
                    ${botonAccion}
                </div>
            </div>
            `;
        }).join('');
    }

    function mostrarDescripcion(event, texto) {
        tooltip.innerText = texto;
        tooltip.style.display = 'block';
        // Posicionamos la ventana cerca del mouse
        tooltip.style.left = (event.pageX + 10) + 'px';
        tooltip.style.top = (event.pageY + 10) + 'px';
    }

    function ocultarDescripcion() {
        tooltip.style.display = 'none';
    }

    function enviarWhatsApp(producto) {
        const numero = "54911XXXXXXXX"; // TU NUMERO
        const mensaje = encodeURIComponent(`Hola! Quisiera pedir el producto: ${producto}`);
        window.open(`https://wa.me/${numero}?text=${mensaje}`, '_blank');
    }

    function abrirModalLogin() {
        window.location.href = "/login"; // Mandamos al login real
    }

    function seleccionarPrincipal(idPadre, btn) {
        // 1. Estilo de los botones
        document.querySelectorAll('#categorias-nav .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const subNav = document.getElementById('subcategorias-nav');

        // 2. Si es "Todos"
        if (idPadre === null) {
            subNav.innerHTML = '';
            filtrarPorCategoria('todos');
            return;
        }

        // 3. Filtrar por la categoría padre (Recursivo: trae todo lo de música)
        filtrarPorCategoria(idPadre);

        // 4. Armar el submenú de hijos
        const hijas = categoriasData.filter(c => c.parent && c.parent.id === idPadre);
        if (hijas.length > 0) {
            subNav.innerHTML = '<hr>';
            subNav.innerHTML += `<button class="filter-btn active" onclick="filtrarPorCategoria(${idPadre})">Ver Todo</button>`;
            if (hijas.length > 0) {
                subNav.innerHTML = '<hr>';
                // "Ver Todo" sí llama al servidor para traer todo lo del padre (Cocina o Música)
                subNav.innerHTML += `<button class="filter-btn active" onclick="filtrarPorCategoria(${idPadre})">Ver Todo</button>`;
                
                hijas.forEach(h => {
                    // PERO las subcategorías usan filtrarPorIdSub para ocultar las que no coinciden
                    subNav.innerHTML += `<button class="filter-btn" onclick="filtrarPorIdSub(${h.id}, this)">${h.name}</button>`;
                });
            }
        } else {
            subNav.innerHTML = '';
        }
    }

    function filtrarPorIdSub(idSub, btn) {
        document.querySelectorAll('#subcategorias-nav .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.card').forEach(card => {
            card.classList.toggle('hidden', card.getAttribute('data-category-id') != idSub);
        });
    }

    function filtrarPorCategoria(id) {
        // Siempre traemos todos para que el filtro visual de las hijas funcione
        fetch(`${API_URL}/products/list`)
            .then(res => res.json())
            .then(data => {
                renderizarCards(data); // Dibujamos todo
                
                // Si no es "todos", ocultamos visualmente lo que no pertenezca al padre o a sus hijos
                if (id !== 'todos') {
                    document.querySelectorAll('.card').forEach(card => {
                        const catId = parseInt(card.getAttribute('data-category-id'));
                        // Buscamos si la categoría de la card es la seleccionada o es hija de la seleccionada
                        const esHija = categoriasData.some(c => c.id === catId && c.parent && c.parent.id === id);
                        const esLaMisma = catId === id;
                        
                        card.classList.toggle('hidden', !(esLaMisma || esHija));
                    });
                }
            });
    }

    function filtrarPorTexto() {
        const texto = document.getElementById('busqueda').value.toLowerCase();
        document.querySelectorAll('.card').forEach(card => {
            const titulo = card.querySelector('h3').innerText.toLowerCase();
            card.style.display = titulo.includes(texto) ? "" : "none";
        });
    }

    </script>
</body>

<footer style="margin-top: 50px; text-align: right; padding: 10px;">
    <a href="/login" style="color: rgba(255,255,255,0.1); text-decoration: none; font-size: 0.8rem;">Acceso Admin</a>
</footer>

</html>